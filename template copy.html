<script>
    // 1. INJECT & NORMALIZE DATA
    const rawTours = <%- JSON.stringify(featuredTours || []) %>;
    
    const toursData = rawTours.map(tour => {
        // Handle 'category': Check if it's an array, a string, or null
        let catArray = ["General"];
        if (tour.category) {
            // If it's already an array, use it. If it's a string, wrap it in an array.
            catArray = Array.isArray(tour.category) ? tour.category : [tour.category];
        } else if (tour.categories) {
            // Fallback if your DB uses plural 'categories'
            catArray = Array.isArray(tour.categories) ? tour.categories : [tour.categories];
        }

        return {
            id: tour.id || Math.random(),
            title: tour.title,
            description: tour.short_description || "", 
            image: tour.main_image || '/images/placeholder-tour.jpg',
            price: tour.price,
            duration: tour.duration_days ? `${tour.duration_days} Days` : "Flexible",
            location: tour.location,
            slug: tour.slug,
            
            // NEW: Use the processed category array here
            categories: catArray, 
            
            // Defaults
            groupSize: tour.group_size || "Small Group",
            rating: tour.rating || 5.0,
            reviews: tour.reviews_count || 0
        };
    });

    function renderTours(filter) {
        const grid = document.getElementById('tours-grid');
        grid.innerHTML = '';

        const filteredTours = toursData.filter(tour => {
            if (filter === 'All') return true;
            // UPDATE: Check if the category array includes the filter
            return tour.categories.includes(filter) || tour.title.includes(filter);
        });

        if (filteredTours.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center text-muted-foreground py-12">
                    <p>No tours found matching this filter.</p>
                </div>`;
            return;
        }

        filteredTours.forEach((tour, index) => {
            const card = document.createElement('div');
            card.className = "group relative bg-card rounded-2xl overflow-hidden shadow-sm border border-border transition-all duration-500 hover:shadow-xl hover:shadow-primary/5 hover:-translate-y-2 opacity-0 translate-y-10 reveal-card";
            card.style.transitionDelay = `${index * 100}ms`;
            card.style.animationFillMode = "forwards"; 

            // UPDATE: Generate Category Badges instead of Tags
            const categoriesHtml = tour.categories.map(cat => 
                `<span class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors border-transparent bg-secondary text-secondary-foreground shadow-sm group-hover:bg-white/90 group-hover:text-black">${cat}</span>`
            ).join('');

            card.innerHTML = `
                <div class="relative h-64 overflow-hidden">
                    <img src="${tour.image}" alt="${tour.title}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                    
                    <div class="absolute top-4 left-4 flex flex-wrap gap-2">
                        ${categoriesHtml}
                    </div>

                    <button class="like-btn absolute top-4 right-4 p-2 rounded-full bg-white/20 backdrop-blur-sm hover:bg-white/40 transition-all duration-300 text-white">
                        <i data-lucide="heart" class="h-5 w-5 transition-transform"></i>
                    </button>

                    <div class="absolute bottom-4 right-4 bg-white/95 backdrop-blur-sm px-3 py-1.5 rounded-full shadow-lg">
                        <span class="text-foreground text-sm font-medium">From <span class="text-primary font-semibold">R${parseFloat(tour.price).toLocaleString()}</span></span>
                    </div>
                </div>

                <div class="p-6">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="flex items-center gap-1">
                            <i data-lucide="star" class="h-4 w-4 fill-amber-400 text-amber-400"></i>
                            <span class="text-foreground font-semibold text-sm">${tour.rating}</span>
                        </div>
                        <span class="text-muted-foreground text-sm">(${tour.reviews} reviews)</span>
                    </div>

                    <h3 class="font-serif text-xl font-semibold text-foreground mb-2 group-hover:text-primary transition-colors duration-300">${tour.title}</h3>
                    <p class="text-muted-foreground text-sm leading-relaxed mb-4 line-clamp-2">${tour.description}</p>
                    
                    <div class="flex flex-wrap items-center gap-4 text-sm text-muted-foreground mb-5">
                        <div class="flex items-center gap-1.5"><i data-lucide="clock" class="h-4 w-4 text-primary"></i> <span>${tour.duration}</span></div>
                        <div class="flex items-center gap-1.5"><i data-lucide="users" class="h-4 w-4 text-primary"></i> <span>${tour.groupSize}</span></div>
                        <div class="flex items-center gap-1.5"><i data-lucide="map-pin" class="h-4 w-4 text-primary"></i> <span>${tour.location}</span></div>
                    </div>
                    
                    <a href="/tours/${tour.slug}" class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-primary bg-transparent hover:bg-primary hover:text-primary-foreground h-10 px-4 py-2 w-full rounded-full group/btn transition-all duration-300">
                        View Details <i data-lucide="arrow-right" class="ml-2 h-4 w-4 transition-transform group-hover/btn:translate-x-1"></i>
                    </a>
                </div>
            `;
            grid.appendChild(card);
            
            setTimeout(() => {
                card.classList.remove('opacity-0', 'translate-y-10');
            }, 50 + (index * 100));
        });

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const icon = btn.querySelector('i');
                if (icon.classList.contains('fill-red-500')) {
                    icon.classList.remove('fill-red-500', 'text-red-500');
                    icon.classList.add('text-white');
                    btn.classList.remove('scale-110');
                } else {
                    icon.classList.add('fill-red-500', 'text-red-500');
                    icon.classList.remove('text-white');
                    btn.classList.add('scale-110');
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderTours('All');

        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                filterBtns.forEach(b => {
                    b.classList.remove('bg-primary', 'text-primary-foreground', 'shadow-lg');
                    b.classList.add('bg-secondary', 'text-secondary-foreground');
                });
                e.target.classList.remove('bg-secondary', 'text-secondary-foreground');
                e.target.classList.add('bg-primary', 'text-primary-foreground', 'shadow-lg');
                
                renderTours(e.target.dataset.filter);
            });
        });
    });
</script>