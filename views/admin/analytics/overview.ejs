<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Intelligence - Casalinga Tours</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/admin/sidebar-styles.css">
    
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            primary: "#1a5d2c",
            "primary-light": "#e8f5e9",
            secondary: "#f8f5ee",
            accent: "#d4a574",
            border: "hsl(214.3 31.8% 91.4%)",
            background: "#f8f9fc" // Slightly grey background for dashboard contrast
          },
          boxShadow: {
            'dashboard': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
            'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)'
          }
        }
      }
    }
  </script>

  <style>
    /* Dashboard specific overrides */
    body { background-color: #f3f4f6; }
    
    /* Power BI Style Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      grid-auto-rows: minmax(140px, auto);
      gap: 1.5rem;
    }

    /* Card Styling */
    .bi-card {
      background: white;
      border-radius: 0.75rem;
      border: 1px solid rgba(229, 231, 235, 0.5);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    
    .bi-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }

    .bi-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .bi-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .bi-content {
      padding: 1.5rem;
      flex: 1;
      position: relative;
    }

    /* KPI Value styling */
    .kpi-value { font-size: 2rem; font-weight: 700; color: #111827; line-height: 1; }
    .kpi-label { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
    .kpi-trend { font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; gap: 0.25rem; margin-top: 0.75rem; }
    
    /* Grid Spans */
    .col-span-12 { grid-column: span 12; }
    .col-span-8 { grid-column: span 8; }
    .col-span-6 { grid-column: span 6; }
    .col-span-4 { grid-column: span 4; }
    .col-span-3 { grid-column: span 3; }
    
    .row-span-2 { grid-row: span 2; }

    /* Ensure charts have proper dimensions */
    canvas {
        width: 100% !important;
        height: 100% !important;
    }

    /* Fix table responsiveness */
    .overflow-x-auto {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Ensure proper spacing in KPI cards */
    .kpi-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #111827;
        line-height: 1.2;
        margin-top: 0.25rem;
    }

    /* Improve chart container sizing */
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    /* Fix for mobile view */
    @media (max-width: 768px) {
        .bi-card {
            margin-bottom: 1rem;
        }
        
        .kpi-value {
            font-size: 1.5rem;
        }
        
        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
    }

    @media (max-width: 1280px) {
      .xl\:col-span-6 { grid-column: span 6; }
      .xl\:col-span-12 { grid-column: span 12; }
    }
    @media (max-width: 1024px) {
      .lg\:col-span-12 { grid-column: span 12; }
      .dashboard-grid { gap: 1rem; }
    }
    @media (max-width: 768px) {
      .dashboard-grid { display: flex; flex-direction: column; }
    }
  </style>
</head>
<body>
  
  <div class="app-wrapper flex h-screen overflow-hidden">
    <aside class="sidebar bg-white border-r border-gray-200 w-64 fixed inset-y-0 left-0 z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300" id="sidebar">
        <%- include('admin-sidebar') %>
    </aside>

    <main class="main-content flex-1 ml-0 md:ml-64 flex flex-col h-full overflow-hidden">
      
      <header class="bg-white border-b border-gray-200 sticky top-0 z-30 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button id="mobileToggle" class="md:hidden text-gray-500 hover:text-gray-700">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <div>
            <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Analytics Intelligence</h1>
            <p class="text-sm text-gray-500">Real-time insights and performance metrics</p>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
          <div class="hidden md:flex bg-gray-100 rounded-lg p-1">
            <a href="?period=month" class="px-3 py-1.5 text-sm font-medium rounded-md <%= period === 'month' ? 'bg-white text-primary shadow-sm' : 'text-gray-500 hover:text-gray-700' %> transition-all">Monthly</a>
            <a href="?period=year" class="px-3 py-1.5 text-sm font-medium rounded-md <%= period === 'year' ? 'bg-white text-primary shadow-sm' : 'text-gray-500 hover:text-gray-700' %> transition-all">Yearly</a>
          </div>
          <button class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-green-800 transition-colors shadow-sm">
            <i class="fas fa-file-export"></i> Export Report
          </button>
        </div>
      </header>

      <div class="flex-1 overflow-y-auto p-6">
        
        <div class="dashboard-grid">

          <div class="bi-card col-span-3">
            <div class="bi-content">
              <div class="flex justify-between items-start">
                <div>
                  <div class="text-xs font-semibold text-accent uppercase tracking-wider">Total Revenue</div>
                  <div class="kpi-value mt-2" id="kpi-revenue">R0</div>
                </div>
                <div class="p-2 bg-green-50 rounded-lg text-primary">
                  <i class="fas fa-sack-dollar text-xl"></i>
                </div>
              </div>
              <div class="kpi-trend text-green-600">
                <i class="fas fa-arrow-trend-up"></i>
                <span id="kpi-revenue-trend">0%</span>
                <span class="text-gray-400 font-normal ml-1">vs last period</span>
              </div>
            </div>
          </div>

          <div class="bi-card col-span-3">
            <div class="bi-content">
              <div class="flex justify-between items-start">
                <div>
                  <div class="text-xs font-semibold text-accent uppercase tracking-wider">Total Bookings</div>
                  <div class="kpi-value mt-2" id="kpi-bookings">0</div>
                </div>
                <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                  <i class="fas fa-ticket text-xl"></i>
                </div>
              </div>
              <div class="kpi-trend text-blue-600">
                <i class="fas fa-chart-bar"></i>
                <span class="text-gray-600 font-normal ml-1">Avg Price: <span id="kpi-avg-price" class="font-bold">R0</span></span>
              </div>
            </div>
          </div>

          <div class="bi-card col-span-3">
            <div class="bi-content">
              <div class="flex justify-between items-start">
                <div>
                  <div class="text-xs font-semibold text-accent uppercase tracking-wider">New Customers</div>
                  <div class="kpi-value mt-2" id="kpi-customers">0</div>
                </div>
                <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
                  <i class="fas fa-users text-xl"></i>
                </div>
              </div>
              <div class="mt-4 h-1.5 w-full bg-gray-100 rounded-full overflow-hidden">
                <div class="h-full bg-purple-500 rounded-full" style="width: 65%"></div>
              </div>
              <div class="kpi-label mt-2">Conversion Rate: <span class="font-bold text-gray-800">4.2%</span></div>
            </div>
          </div>

          <div class="bi-card col-span-3">
            <div class="bi-content">
              <div class="flex justify-between items-start">
                <div>
                  <div class="text-xs font-semibold text-accent uppercase tracking-wider">Top Category</div>
                  <div class="text-xl font-bold text-gray-900 mt-2 truncate" id="kpi-top-category">Loading...</div>
                </div>
                <div class="p-2 bg-orange-50 rounded-lg text-orange-600">
                  <i class="fas fa-crown text-xl"></i>
                </div>
              </div>
              <div class="kpi-trend text-orange-600">
                <span id="kpi-top-cat-value">R0</span>
                <span class="text-gray-400 font-normal ml-1">revenue generated</span>
              </div>
            </div>
          </div>

          <div class="bi-card col-span-8 row-span-2">
            <div class="bi-header">
              <span class="bi-title">Revenue Performance Trend</span>
              <div class="flex gap-2">
                <span class="w-3 h-3 rounded-full bg-primary inline-block"></span>
                <span class="text-xs text-gray-500">Revenue</span>
                <span class="w-3 h-3 rounded-full bg-accent inline-block ml-2"></span>
                <span class="text-xs text-gray-500">Bookings</span>
              </div>
            </div>
            <div class="bi-content">
              <canvas id="revenueChart" style="max-height: 350px;"></canvas>
            </div>
          </div>

          <div class="bi-card col-span-4 row-span-2">
            <div class="bi-header">
              <span class="bi-title">Revenue by Category</span>
            </div>
            <div class="bi-content flex flex-col justify-center items-center">
              <div class="relative w-full h-64">
                <canvas id="categoryChart"></canvas>
              </div>
              <div class="mt-4 w-full" id="category-legend">
                </div>
            </div>
          </div>

          <div class="bi-card col-span-6">
            <div class="bi-header">
              <span class="bi-title">VIP Customers</span>
              <a href="/admin/users" class="text-xs text-primary hover:underline">View All</a>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                  <tr>
                    <th class="px-6 py-3">Customer</th>
                    <th class="px-6 py-3 text-center">Trips</th>
                    <th class="px-6 py-3 text-right">LTV (Spend)</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="top-customers-body">
                  <% if (topCustomers && topCustomers.length > 0) { %>
                    <% topCustomers.forEach(customer => { %>
                      <tr class="hover:bg-gray-50/80 transition-colors">
                        <td class="px-6 py-3 font-medium text-gray-900 flex items-center gap-3">
                          <div class="w-8 h-8 rounded-full bg-primary/10 text-primary flex items-center justify-center font-bold text-xs">
                            <%= customer.name.charAt(0).toUpperCase() %>
                          </div>
                          <div>
                            <div class="font-semibold"><%= customer.name %></div>
                            <div class="text-xs text-gray-500"><%= customer.email %></div>
                          </div>
                        </td>
                        <td class="px-6 py-3 text-center">
                          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                            <%= customer.total_bookings %>
                          </span>
                        </td>
                        <td class="px-6 py-3 text-right font-bold text-gray-900">
                          R<%= parseFloat(customer.total_spent).toLocaleString() %>
                        </td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No data available</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <div class="bi-card col-span-6">
            <div class="bi-header">
              <span class="bi-title">Customer Acquisition</span>
            </div>
            <div class="bi-content">
              <canvas id="customerChart" style="max-height: 250px;"></canvas>
            </div>
          </div>

        </div> <div class="mt-8 text-center text-xs text-gray-400">
          Generated on <%= moment().format('MMMM Do YYYY, h:mm:ss a') %> â€¢ Casalinga Tours Admin System
        </div>

      </div>
    </main>
  </div>

<script>
    // --- 1. DATA INGESTION ---
    const revenueData = <%- JSON.stringify(revenueTrend || []) %>;
    const categoryData = <%- JSON.stringify(revenueByCategory || []) %>;
    const customerData = <%- JSON.stringify(customerDemographics || []) %>;

    // Format numbers with R prefix
    function formatCurrency(amount) {
        return 'R' + parseFloat(amount || 0).toLocaleString('en-ZA', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }

    // --- 2. SMART CALCULATIONS ---
    const calculateStats = () => {
        // Total Revenue from server-side calculation
        document.getElementById('kpi-revenue').innerText = formatCurrency(<%= kpis.totalRevenue %>);
        
        // Total Bookings
        document.getElementById('kpi-bookings').innerText = <%= kpis.totalBookings %>.toLocaleString();
        
        // Average Booking Value
        document.getElementById('kpi-avg-price').innerText = formatCurrency(<%= kpis.avgBookingValue %>);
        
        // Total New Customers
        document.getElementById('kpi-customers').innerText = <%= kpis.totalCustomers %>.toLocaleString();
        
        // Revenue Trend Percentage
        const trendElement = document.getElementById('kpi-revenue-trend');
        const trendPercentage = <%= kpis.revenueTrendPercentage %>;
        trendElement.innerText = Math.abs(trendPercentage) + '%';
        
        // Set trend color and icon
        const trendIcon = trendElement.previousElementSibling;
        if (trendPercentage > 0) {
            trendElement.className = 'text-green-600';
            trendIcon.className = 'fas fa-arrow-trend-up';
        } else if (trendPercentage < 0) {
            trendElement.className = 'text-red-600';
            trendIcon.className = 'fas fa-arrow-trend-down';
        } else {
            trendElement.className = 'text-gray-600';
            trendIcon.className = 'fas fa-minus';
        }
        
        // Top Category
        <% if (kpis.topCategory) { %>
            document.getElementById('kpi-top-category').innerText = '<%= kpis.topCategory.category %>';
            document.getElementById('kpi-top-cat-value').innerText = formatCurrency(<%= kpis.topCategory.revenue %>);
        <% } else { %>
            document.getElementById('kpi-top-category').innerText = 'No data';
            document.getElementById('kpi-top-cat-value').innerText = 'R0';
        <% } %>
    };

    // Call on page load
    document.addEventListener('DOMContentLoaded', calculateStats);

    // --- 3. CHART.JS CONFIGURATION ---
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6b7280';
    
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: '#1f2937',
                titleFont: { size: 13 },
                bodyFont: { size: 13 },
                padding: 10,
                cornerRadius: 8,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) label += ': ';
                        if (context.parsed.y !== null) {
                            if (label.includes('Revenue') || context.dataset.label === 'Revenue') {
                                return label + formatCurrency(context.parsed.y);
                            } else {
                                return label + context.parsed.y;
                            }
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            x: { 
                grid: { display: false },
                ticks: { maxRotation: 45 }
            },
            y: { 
                grid: { color: '#f3f4f6' },
                beginAtZero: true
            }
        }
    };

    // Wait for DOM to be fully loaded before creating charts
    document.addEventListener('DOMContentLoaded', function() {
        // Revenue Chart
        if (revenueData.length > 0) {
            const ctxRev = document.getElementById('revenueChart');
            if (ctxRev) {
                new Chart(ctxRev.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: revenueData.map(d => new Date(d.month).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
                        datasets: [
                            {
                                label: 'Revenue',
                                data: revenueData.map(d => d.revenue),
                                borderColor: '#1a5d2c',
                                backgroundColor: 'rgba(26, 93, 44, 0.05)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Bookings',
                                data: revenueData.map(d => d.bookings),
                                type: 'bar',
                                backgroundColor: 'rgba(212, 165, 116, 0.7)',
                                borderRadius: 4,
                                barThickness: 12,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        ...commonOptions,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { grid: { display: false } },
                            y: { 
                                position: 'left',
                                type: 'linear',
                                ticks: { 
                                    callback: (value) => 'R' + (value / 1000).toFixed(0) + 'k'
                                }
                            },
                            y1: {
                                position: 'right',
                                type: 'linear',
                                grid: { drawOnChartArea: false },
                                ticks: { 
                                    callback: (value) => value.toFixed(0)
                                }
                            }
                        }
                    }
                });
            }
        }

        // Category Chart
        if (categoryData.length > 0) {
            const ctxCat = document.getElementById('categoryChart');
            if (ctxCat) {
                // Define a color palette
                const colors = [
                    '#1a5d2c', '#2e7d32', '#4caf50', '#81c784', '#a5d6a7',
                    '#d4a574', '#bc8a5f', '#a47148', '#8b5a2b', '#654321'
                ];
                
                const catChart = new Chart(ctxCat.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: categoryData.map(d => d.category),
                        datasets: [{
                            data: categoryData.map(d => d.revenue),
                            backgroundColor: colors.slice(0, categoryData.length),
                            borderWidth: 0,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        return `${context.label}: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Update custom legend
                const legendContainer = document.getElementById('category-legend');
                if (legendContainer) {
                    legendContainer.innerHTML = '';
                    categoryData.forEach((item, index) => {
                        const color = colors[index % colors.length];
                        legendContainer.innerHTML += `
                            <div class="flex items-center justify-between text-xs mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                                    <span class="text-gray-600 truncate">${item.category}</span>
                                </div>
                                <span class="font-bold text-gray-900">${formatCurrency(item.revenue)}</span>
                            </div>
                        `;
                    });
                }
            }
        }

        // Customer Chart
        if (customerData.length > 0) {
            const ctxCust = document.getElementById('customerChart');
            if (ctxCust) {
                new Chart(ctxCust.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: customerData.map(d => new Date(d.month).toLocaleDateString('en-US', { month: 'short' })),
                        datasets: [{
                            label: 'New Customers',
                            data: customerData.map(d => d.new_customers),
                            backgroundColor: '#1a5d2c',
                            borderRadius: 4,
                            barThickness: 20
                        }]
                    },
                    options: commonOptions
                });
            }
        }
    });

    // Mobile Sidebar Toggle
    document.addEventListener('DOMContentLoaded', function() {
        const mobileToggle = document.getElementById('mobileToggle');
        const sidebar = document.getElementById('sidebar');
        
        if (mobileToggle && sidebar) {
            mobileToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 768 && 
                    !sidebar.contains(e.target) && 
                    e.target !== mobileToggle && 
                    !mobileToggle.contains(e.target)) {
                    sidebar.classList.add('-translate-x-full');
                }
            });
        }
    });
</script>
</body>
</html>